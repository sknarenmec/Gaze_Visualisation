<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WebGazer Eye Tracking Study</title>

<link rel="stylesheet" href="./css/style.css">
<script src="webgazer.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body, html { margin:0; padding:0; height:100%; overflow:hidden; background:white; }
#imageContainer { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); }
button { padding:10px 20px; cursor:pointer; }
#downloadDataBtn { position:absolute; bottom:10px; left:10px; background:rgb(2,255,213);}
#pauseResumeBtn { position:absolute; bottom:10px; right:10px; background:rgb(206,255,31);}
#skipBtn { position:absolute; top:10px; right:20px; background:rgb(255,100,100);}
#endStudyBtn { position:absolute; bottom:50px; right:20px; background:rgb(255,50,50); display:none;}
#progressBar { width:80%; height:20px; background:#e0e0e0; border-radius:10px; overflow:hidden; position:fixed; bottom:20px; left:50%; transform:translateX(-50%);}
#progressBarFill { height:100%; background:blue; width:0%; transition:width 0.2s;}
#completionMessage { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; color:black; padding:20px; border:2px solid black; display:none; z-index:1000;}
</style>
</head>
<body>

<div id="imageContainer"></div>

<button id="downloadDataBtn" onclick="downloadData()">Download</button>
<button id="pauseResumeBtn" onclick="toggleStudy()">Pause Study</button>
<button id="skipBtn" onclick="skipImage()">Skip Image</button>
<button id="endStudyBtn" onclick="endStudy()">End Study</button>

<div id="progressBar"><div id="progressBarFill"></div></div>

<div id="completionMessage">
  <p>Study Completed!</p>
  <p style="color:red;font-weight:bold;">Please download your gaze data.</p>
  <button onclick="navigateToResults()">Go to Results</button>
</div>

<script>
let gazeData = [];
let currentImageIndex = 0;
let isPaused = false;
let imageTimer;
let imageStartTime;
let progressBarAnimationFrame;
let subjectName = sessionStorage.getItem('subjectName') || prompt("Enter subject name:");
if(!subjectName) subjectName = "Unnamed_Subject";

const images = [
  { src:'assets/1.webp', duration:10000 },
  { src:'assets/3.png', duration:10000 },
  { src:'assets/4.webp', duration:10000 },
  { src:'assets/5.webp', duration:10000 },
];

const imageContainer = document.getElementById('imageContainer');
const progressBarFill = document.getElementById('progressBarFill');
const completionMessage = document.getElementById('completionMessage');

function startWebGazerStudy() {
    webgazer.params.applyKalmanFilter = true;
    webgazer.params.showVideoPreview = true;
    webgazer.params.showFaceOverlay = false;
    webgazer.params.showFaceFeedbackBox = false;

    webgazer.setGazeListener((data, elapsedTime)=>{
        if(!isPaused && data) {
            const rect = imageContainer.getBoundingClientRect();
            const relativeX = data.x - rect.left;
            const relativeY = data.y - rect.top;

            gazeData.push({
                imagePath: currentImageIndex < images.length ? images[currentImageIndex].src : null,
                gazePoint: { x: relativeX, y: relativeY },
                timestamp: elapsedTime,
                subject: subjectName
            });
        }
    }).begin().then(()=>{
        const videoContainer = document.getElementById('webgazerVideoContainer');
        if(videoContainer){
            videoContainer.style.position='fixed';
            videoContainer.style.top='10px';
            videoContainer.style.left='10px';
            videoContainer.style.width='320px';
            videoContainer.style.height='240px';
            videoContainer.style.zIndex=9999;
        }
        showNextImage();
    });
}

function showNextImage(){
    if(currentImageIndex >= images.length) return completeStudy();

    const img = document.createElement('img');
    img.src = images[currentImageIndex].src;
    img.style.width='1792px';
    img.style.height='1024px';
    img.style.objectFit='none';
    imageContainer.innerHTML='';
    imageContainer.appendChild(img);

    imageStartTime = performance.now();
    showProgressBar(images[currentImageIndex].duration);
    currentImageIndex++;
}

function showProgressBar(duration){
    let timeElapsed = 0;
    progressBarFill.style.width='0%';

    function update(){
        if(isPaused) return;
        timeElapsed += 100;
        const percent = Math.min((timeElapsed/duration)*100,100);
        progressBarFill.style.width = percent + '%';
        if(percent >= 100) return completeCurrentImage();
        progressBarAnimationFrame = setTimeout(update,100);
    }
    update();
}

function completeCurrentImage(){ showNextImage(); }

function toggleStudy(){
    isPaused = !isPaused;
    document.getElementById('pauseResumeBtn').innerText = isPaused ? 'Resume Study':'Pause Study';
    document.getElementById('skipBtn').style.display = isPaused ? 'none':'inline-block';
    document.getElementById('endStudyBtn').style.display = isPaused ? 'inline-block':'none';
}

function skipImage(){
    clearTimeout(progressBarAnimationFrame);
    completeCurrentImage();
}

function endStudy(){
    completeStudy();
    downloadData();
    setTimeout(()=>window.location.href='./results.html',1500);
}

function completeStudy(){
    clearTimeout(progressBarAnimationFrame);
    completionMessage.style.display='block';
    downloadData();
}

function downloadData(){
    const json = JSON.stringify({subject:subjectName, gazeData:gazeData},null,2);
    const blob = new Blob([json],{type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url;
    a.download='gaze_data.json';
    a.click();
    URL.revokeObjectURL(url);
}

function navigateToResults(){ window.location.href='./results.html'; }

window.onload = ()=>{ startWebGazerStudy(); };
</script>

</body>
</html>
