<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eye Tracking Results</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ---------- Styles (unchanged except canvas size) ---------- */
        :root {
            --primary: #3498db;
            --primary-dark: #2980b9;
            --secondary: #2c3e50;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --success: #2ecc71;
            --warning: #f39c12;
            --gray: #95a5a6;
            --light-gray: #f5f7fa;
            --white: #ffffff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --radius: 8px;
        }
        * { box-sizing: border-box; margin:0; padding:0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;}
        body { background-color: var(--light-gray); color: var(--dark); line-height: 1.6; padding: 20px; max-width: 1400px; margin: 0 auto;}
        header { display:flex; justify-content:space-between; align-items:center; margin-bottom:30px; padding:20px; background: var(--white); border-radius: var(--radius); box-shadow: var(--shadow);}
        h1 { color: var(--secondary); font-size:2.2rem; font-weight:700;}
        h2 { color: var(--secondary); margin-bottom:15px; font-weight:600;}
        h3 { color: var(--secondary); margin-bottom:10px; font-weight:500;}
        .btn { display:inline-flex; align-items:center; gap:8px; padding:12px 20px; border-radius: var(--radius); cursor:pointer; font-weight:600; transition: all 0.3s ease; border:none; text-decoration:none;}
        .btn-primary { background-color: var(--primary); color: var(--white); box-shadow: var(--shadow);}
        .btn-primary:hover { background-color: var(--primary-dark); transform: translateY(-2px);}
        .btn-secondary { background-color: var(--secondary); color: var(--white);}
        .btn-secondary:hover:not(:disabled) { background-color:#1a2530;}
        .btn:disabled { background-color: var(--gray); cursor:not-allowed; transform:none;}
        .card { background-color: var(--white); border-radius: var(--radius); box-shadow: var(--shadow); padding:20px; margin-bottom:20px;}
        .subject-info { display:flex; align-items:center; gap:15px; margin-bottom:20px;}
        .subject-avatar { width:60px; height:60px; border-radius:50%; background-color: var(--primary); display:flex; align-items:center; justify-content:center; color: var(--white); font-size:1.5rem; font-weight:bold;}
        .subject-details h2 { margin-bottom:5px;}
        .subject-details p { color: var(--gray);}
        .upload-container { margin-bottom:25px;}
        .upload-container label { display:block; margin-bottom:10px; font-weight:bold;}
        .file-input-container { position:relative; display:flex; gap:10px;}
        #fileInput { flex:1; padding:12px; border:2px dashed var(--gray); border-radius: var(--radius); background-color: var(--light);}
        .loading-spinner { display:none; text-align:center; margin:20px 0;}
        .spinner { border:4px solid rgba(0,0,0,0.1); border-left:4px solid var(--primary); border-radius:50%; width:30px; height:30px; animation:spin 1s linear infinite; margin:0 auto;}
        @keyframes spin { 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);}}
        .nav-buttons { display:flex; justify-content:center; gap:15px; margin:20px 0;}
        .visualization-container { position:relative; margin-bottom:20px;}
        .heatmap-canvas { width:1792px; height:1024px; border-radius: var(--radius); background-color: var(--light); border:1px solid #ddd;}
        .image-info { display:flex; justify-content:space-between; margin-top:10px; color: var(--gray);}
        .charts-container { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:20px;}
        @media (max-width:992px) { .charts-container { grid-template-columns:1fr; } }
        .chart-container { background-color: var(--white); padding:20px; border-radius: var(--radius); box-shadow: var(--shadow);}
        .chart-title { text-align:center; margin-bottom:15px; color: var(--secondary);}
        .data-summary { display:grid; grid-template-columns: repeat(auto-fit,minmax(200px,1fr)); gap:15px; margin-bottom:20px;}
        .summary-card { background:var(--white); padding:15px; border-radius:var(--radius); box-shadow:var(--shadow); text-align:center;}
        .summary-value { font-size:2rem; font-weight:bold; color: var(--primary); margin:10px 0;}
        .summary-label { color: var(--gray); font-size:0.9rem;}
        .analysis-container { margin-top:20px;}
        .analysis-section { margin-bottom:25px;}
        .analysis-points { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:15px;}
        .analysis-card { background: var(--white); padding:15px; border-radius:var(--radius); box-shadow:var(--shadow); border-left:4px solid var(--primary);}
        .analysis-card h4 { display:flex; align-items:center; gap:10px; margin-bottom:10px; color: var(--secondary);}
        .analysis-card i { color: var(--primary);}
        .notification { position:fixed; top:20px; right:20px; padding:15px 20px; background-color: var(--accent); color: var(--white); border-radius:var(--radius); box-shadow:var(--shadow); display:none; z-index:1000; animation:slideIn 0.3s ease;}
        @keyframes slideIn { from {transform:translateX(100px); opacity:0;} to {transform:translateX(0); opacity:1;} }
        footer { text-align:center; margin-top:40px; padding:20px; color:var(--gray); border-top:1px solid #ddd;}
        .image-placeholder { width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; background:linear-gradient(135deg,#e0e0e0 0%,#f5f5f5 100%); border-radius: var(--radius); color:#777; font-size:1.1rem; text-align:center; padding:20px; box-sizing:border-box;}
        .image-placeholder i { font-size:3rem; margin-bottom:15px; color:var(--primary);}
        .image-placeholder .image-name { font-weight:bold; margin-top:10px; font-size:1.2rem; color:var(--secondary); word-break:break-all; max-width:100%;}
        @media (max-width:768px){ body{padding:15px;} header{flex-direction:column; gap:15px; text-align:center;} h1{font-size:1.8rem;} .subject-info{flex-direction:column; text-align:center;} .file-input-container{flex-direction:column;}}
    </style>
</head>
<body>
    <div class="notification" id="notification"></div>

    <header>
        <h1><i class="fas fa-eye"></i> Gaze Study Visualization</h1>
        <button id="newStudyButton" class="btn btn-primary" onclick="navigateToIndex()">
            <i class="fas fa-plus"></i> New Study
        </button>
    </header>

    <div class="card">
        <div class="subject-info">
            <div class="subject-avatar" id="subjectAvatar">U</div>
            <div class="subject-details">
                <h2 id="subjectName">Unknown Subject</h2>
                <p id="subjectDetails">Upload JSON data to view analysis</p>
            </div>
        </div>

        <div class="upload-container">
            <label for="fileInput"><i class="fas fa-upload"></i> Upload JSON File</label>
            <div class="file-input-container">
                <input type="file" id="fileInput" accept=".json">
            </div>
        </div>
    </div>

    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner"></div>
        <p>Processing data, please wait...</p>
    </div>

    <div id="dataSummary" class="data-summary" style="display:none;">
        <div class="summary-card">
            <div class="summary-label">Total Gaze Points</div>
            <div class="summary-value" id="totalGazePoints">0</div>
            <div class="summary-label">Across all images</div>
        </div>
        <div class="summary-card">
            <div class="summary-label">Images Analyzed</div>
            <div class="summary-value" id="imagesTracked">0</div>
            <div class="summary-label">In this session</div>
        </div>
        <div class="summary-card">
            <div class="summary-label">Session Duration</div>
            <div class="summary-value" id="trackingDuration">0</div>
            <div class="summary-label">Seconds</div>
        </div>
        <div class="summary-card">
            <div class="summary-label">Avg. Fixations</div>
            <div class="summary-value" id="avgFixations">0</div>
            <div class="summary-label">Per image</div>
        </div>
    </div>

    <div class="nav-buttons">
        <button id="prevBtn" class="btn btn-secondary" disabled><i class="fas fa-chevron-left"></i> Previous Image</button>
        <span id="imageCounter">Image 0 of 0</span>
        <button id="nextBtn" class="btn btn-secondary" disabled>Next Image <i class="fas fa-chevron-right"></i></button>
    </div>

    <div class="card visualization-container">
        <h2 class="chart-title">Gaze Heatmap Visualization</h2>
        <div id="imagePlaceholder" class="image-placeholder">
            <i class="fas fa-image"></i>
            <p>Image will be displayed here</p>
            <p class="image-name" id="placeholderImageName">No image loaded</p>
        </div>

        <img id="stimulus" src="" style="display:none;" />
        <canvas id="gazeCanvas" class="heatmap-canvas" style="display:none;"></canvas>

        <div style="text-align:center; margin-top:10px;">
            <button id="togglePathBtn" class="btn btn-secondary">Hide Gaze Path</button>
        </div>

        <div class="image-info">
            <span id="currentImageName">No image loaded</span>
            <span id="gazePointsCount">0 gaze points</span>
        </div>
    </div>

    <div class="charts-container">
        <div class="chart-container">
            <h2 class="chart-title">Fixation Distribution</h2>
            <canvas id="fixationChart" width="300" height="300"></canvas>
        </div>
        <div class="chart-container">
            <h2 class="chart-title">Gaze Timeline</h2>
            <canvas id="timelineChart" width="900" height="400"></canvas>
        </div>
    </div>

    <div class="card analysis-container">
        <h2>Data Analysis</h2>
        <div id="analysisContent">
            <p>Upload a JSON file to see detailed analysis of the eye tracking data.</p>
        </div>
    </div>

    <footer>
        &copy; 2025 Eye Tracking Study Research - Nithiya R
    </footer>

    <script>
        // ========= Variables =========
        let currentData = null;
        let currentIndex = 0;
        let imageGazeData = {};
        let currentImagePath = '';
        let showGazePath = true;

        const fileInput = document.getElementById('fileInput');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const subjectNameElement = document.getElementById('subjectName');
        const subjectAvatar = document.getElementById('subjectAvatar');
        const subjectDetails = document.getElementById('subjectDetails');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const notification = document.getElementById('notification');
        const dataSummary = document.getElementById('dataSummary');
        const totalGazePoints = document.getElementById('totalGazePoints');
        const imagesTracked = document.getElementById('imagesTracked');
        const trackingDuration = document.getElementById('trackingDuration');
        const avgFixations = document.getElementById('avgFixations');
        const imageCounter = document.getElementById('imageCounter');
        const currentImageName = document.getElementById('currentImageName');
        const gazePointsCount = document.getElementById('gazePointsCount');
        const analysisContent = document.getElementById('analysisContent');
        const imagePlaceholder = document.getElementById('imagePlaceholder');
        const placeholderImageName = document.getElementById('placeholderImageName');
        const heatmapCanvas = document.getElementById('gazeCanvas');
        const stimulusImg = document.getElementById('stimulus');

        // ========= Functions =========
        function navigateToIndex(){ window.location.href='index.html'; }
        function showNotification(msg, isError=true){ notification.textContent=msg; notification.style.backgroundColor=isError?'#e74c3c':'#2ecc71'; notification.style.display='block'; setTimeout(()=>{notification.style.display='none';},3000);}
        
        function updateHeatmap(img, gazePoints, canvas){
            const ctx = canvas.getContext("2d");
            canvas.width = 1792;
            canvas.height = 1024;
            ctx.clearRect(0,0,canvas.width,canvas.height);
            ctx.drawImage(img,0,0,canvas.width,canvas.height);

            if(!gazePoints || gazePoints.length===0) return;

            // Draw path
            if(showGazePath){
                ctx.beginPath();
                gazePoints.forEach((p,i)=>{
                    const x = p.gazePoint?.x || 0;
                    const y = p.gazePoint?.y || 0;
                    if(i===0) ctx.moveTo(x,y);
                    else ctx.lineTo(x,y);
                });
                ctx.strokeStyle="rgba(0,0,0,0.6)";
                ctx.lineWidth=3;
                ctx.stroke();
            }

            // Draw points
            gazePoints.forEach((p,i)=>{
                const x = p.gazePoint?.x || 0;
                const y = p.gazePoint?.y || 0;
                ctx.beginPath();
                if(i===0){ ctx.fillStyle="red"; ctx.arc(x,y,10,0,2*Math.PI);}
                else if(i===gazePoints.length-1){ ctx.fillStyle="blue"; ctx.arc(x,y,10,0,2*Math.PI);}
                else{ ctx.fillStyle="pink"; ctx.arc(x,y,5,0,2*Math.PI);}
                ctx.fill();
            });
        }

        function loadImage(index){
            if(!currentData || !currentData.images || index<0 || index>=currentData.images.length) return;
            currentIndex=index;
            const imgData=currentData.images[index];
            const imgPath=imgData.imagePath;
            const gazePoints=imgData.gazePoints || [];

            imageCounter.textContent=`Image ${index+1} of ${currentData.images.length}`;
            currentImageName.textContent=imgPath.split("/").pop();
            gazePointsCount.textContent=`${gazePoints.length} gaze points`;

            stimulusImg.src=imgPath;
            stimulusImg.style.display="none";
            heatmapCanvas.style.display="none";
            imagePlaceholder.style.display="flex";
            placeholderImageName.textContent=imgPath.split("/").pop();

            stimulusImg.onload=()=>{
                imagePlaceholder.style.display="none";
                heatmapCanvas.style.display="block";
                stimulusImg.style.display="block";
                updateHeatmap(stimulusImg,gazePoints,heatmapCanvas);
            };

            prevBtn.disabled = (index===0);
            nextBtn.disabled = (index===currentData.images.length-1);
        }

        function calculateSummary(){
            if(!currentData) return;
            const totalPoints=currentData.images.reduce((acc,img)=>acc+(img.gazePoints?.length||0),0);
            totalGazePoints.textContent=totalPoints;
            imagesTracked.textContent=currentData.images.length;
            trackingDuration.textContent=currentData.duration || 0;
            avgFixations.textContent=(totalPoints/currentData.images.length).toFixed(1);
            dataSummary.style.display="grid";
        }

        function generateAnalysis(){
            if(!currentData) return;
            let attentionDesc='';
            const avgGazePerImage=currentData.images.reduce((acc,img)=>acc+(img.gazePoints?.length||0),0)/currentData.images.length;
            if(avgGazePerImage>70) attentionDesc="very detailed and thorough scanning";
            else if(avgGazePerImage>=30) attentionDesc="balanced scanning with moderate attention";
            else attentionDesc="skimmed images briefly";

            analysisContent.innerHTML=`<div class="analysis-card"><h4><i class="fas fa-eye"></i> Attention Pattern</h4><p>The subject showed ${attentionDesc} across the images.</p></div>`;
        }

        fileInput.addEventListener('change', (e)=>{
            const file=e.target.files[0];
            if(!file){ showNotification("No file selected!"); return;}
            const reader=new FileReader();
            loadingSpinner.style.display="block";
            reader.onload=function(evt){
                try{
                    const json=JSON.parse(evt.target.result);
                    currentData=json;
                    subjectNameElement.textContent=json.subjectName||"Unknown Subject";
                    subjectAvatar.textContent=(json.subjectName?.charAt(0).toUpperCase()||"U");
                    subjectDetails.textContent=json.subjectId?`ID: ${json.subjectId}`:"";
                    loadingSpinner.style.display="none";
                    calculateSummary();
                    generateAnalysis();
                    loadImage(0);
                }catch(err){ loadingSpinner.style.display="none"; showNotification("Invalid JSON file!"); }
            };
            reader.readAsText(file);
        });

        prevBtn.addEventListener('click',()=>{ loadImage(currentIndex-1); });
        nextBtn.addEventListener('click',()=>{ loadImage(currentIndex+1); });
        document.getElementById('togglePathBtn').addEventListener('click',()=>{
            showGazePath=!showGazePath;
            document.getElementById('togglePathBtn').textContent=showGazePath?"Hide Gaze Path":"Show Gaze Path";
            loadImage(currentIndex);
        });
    </script>
</body>
</html>
