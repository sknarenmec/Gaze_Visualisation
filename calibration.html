<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GazeStudy Calibration</title>

<!-- Custom CSS -->
<link rel="stylesheet" type="text/css" href="./css/style.css">

<!-- Bootstrap CSS from CDN -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- WebGazer -->
<script src="./webgazer.js"></script>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body { position: relative; margin:0; overflow:hidden; }
.red-dot {
  position: absolute;
  background: red;
  border-radius: 50%;
  width: 15px;
  height: 15px;
  pointer-events: none;
  transform: scale(0.5);
  opacity: 0;
  transition: transform 0.3s ease, opacity 0.5s ease;
}
#subjectInfo {
  color: #FFFFFF; font-size: 1.5em; font-weight: bold;
  position: absolute; top:10px; right:20px; z-index:10;
}
.navbar { background-color: #2E3B4E; }
.navbar a { color: #FFFFFF; }
#Accuracy { font-size: 1.2em; font-weight:bold; animation:pulse 1.5s infinite; }
@keyframes pulse { 0%{transform:scale(1);color:red;}50%{transform:scale(1.05);color:orange;}100%{transform:scale(1);color:green;} }

.calibrationDiv { position:absolute; top:0; left:0; width:100%; height:100%; }
.Calibration {
  width: 25px; height:25px; border-radius:50%; background:blue;
  position:absolute; transition: background 0.3s ease, transform 0.3s ease;
}
</style>
</head>
<body>

<div id="subjectInfo"></div>

<nav class="navbar navbar-expand-lg navbar-dark fixed-top">
  <div class="container-fluid">
    <div class="collapse navbar-collapse" id="myNavbar">
      <ul class="navbar-nav me-auto">
        <li id="Accuracy" class="nav-item"><a class="nav-link">Not yet Calibrated</a></li>
        <li class="nav-item"><a onclick="Restart()" href="#" class="nav-link">Recalibrate</a></li>
      </ul>
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="helpBtn nav-link" href="#">Start Study</a></li>
        <li class="nav-item"><a class="nav-link" id="toggleCamBtn" href="#">Show/Hide Camera</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="calibrationDiv">
  <!-- 17 Calibration Points auto-positioned -->
  <input type="button" class="Calibration" id="Pt1">
  <input type="button" class="Calibration" id="Pt2">
  <input type="button" class="Calibration" id="Pt3">
  <input type="button" class="Calibration" id="Pt4">
  <input type="button" class="Calibration" id="Pt5">
  <input type="button" class="Calibration" id="Pt6">
  <input type="button" class="Calibration" id="Pt7">
  <input type="button" class="Calibration" id="Pt8">
  <input type="button" class="Calibration" id="Pt9">
  <input type="button" class="Calibration" id="Pt10">
  <input type="button" class="Calibration" id="Pt11">
  <input type="button" class="Calibration" id="Pt12">
  <input type="button" class="Calibration" id="Pt13">
  <input type="button" class="Calibration" id="Pt14">
  <input type="button" class="Calibration" id="Pt15">
  <input type="button" class="Calibration" id="Pt16">
  <input type="button" class="Calibration" id="Pt17">
</div>

<script>
let gazeData = [];
let isTracking = false;
let startTime;
let calibrationIndex = 0;
const totalPoints = 17;

function startWebGazer() {
  isTracking = true;
  startTime = Date.now();
  webgazer.params.applyKalmanFilter = true;

  // Force video container visible
  setTimeout(() => {
    const videoContainer = document.getElementById('webgazerVideoContainer');
    if(videoContainer){
      videoContainer.style.display = 'block';
      videoContainer.style.position = 'fixed';
      videoContainer.style.top = '10px';
      videoContainer.style.left = '10px';
      videoContainer.style.width = '320px';
      videoContainer.style.height = '240px';
      videoContainer.style.zIndex = 9999;
    }
  },100);

  webgazer.setGazeListener((data)=>{
    if(data && isTracking){
      createRedDot(data.x,data.y);
      gazeData.push({x:data.x, y:data.y, time:Date.now()-startTime});
    }
  }).begin();
}

// Red dot animation
function createRedDot(x,y){
  const dot=document.createElement('div');
  dot.className='red-dot';
  dot.style.left=x+'px';
  dot.style.top=y+'px';
  document.body.appendChild(dot);
  requestAnimationFrame(()=>{
    dot.style.opacity='0.7';
    dot.style.transform='scale(1)';
  });
  setTimeout(()=>{
    dot.style.opacity='0';
    dot.style.transform='scale(0.5)';
    setTimeout(()=>dot.remove(),500);
  },500);
}

// Auto-position calibration points in a grid-like layout
function positionCalibrationPoints(){
  const positions = [
    [10,10],[50,10],[90,10],[10,50],[50,50],[90,50],
    [10,90],[50,90],[90,90],[25,25],[75,25],[25,75],
    [75,75],[50,15],[15,50],[85,50],[50,85]
  ];
  for(let i=1;i<=totalPoints;i++){
    const pt=document.getElementById('Pt'+i);
    pt.style.left=positions[i-1][0]+'%';
    pt.style.top=positions[i-1][1]+'%';
  }
}

// Highlight current calibration point
function highlightCurrentPoint(){
  for(let i=1;i<=totalPoints;i++){
    const pt=document.getElementById('Pt'+i);
    if(i===calibrationIndex+1){
      pt.style.background='red';
      pt.style.transform='scale(1.3)';
    }else{
      pt.style.background='blue';
      pt.style.transform='scale(1)';
    }
  }
}

// Click-to-calibrate flow
function calibrationClickFlow(){
  highlightCurrentPoint();
  for(let i=1;i<=totalPoints;i++){
    const pt=document.getElementById('Pt'+i);
    pt.onclick=()=>{
      if(i-1===calibrationIndex){
        calibrationIndex++;
        if(calibrationIndex>=totalPoints){
          Swal.fire('Calibration Complete!');
        }else{
          highlightCurrentPoint();
        }
      }
    }
  }
}

function startStudy(){
  Swal.fire({
    title:'Start the Study Now?',
    icon:'info',
    showCancelButton:true,
    confirmButtonText:'OK'
  }).then((res)=>{if(res.isConfirmed) window.location.href='study.html';});
}

// Toggle camera
document.getElementById('toggleCamBtn').addEventListener('click',()=>{
  const videoContainer=document.getElementById('webgazerVideoContainer');
  if(videoContainer) videoContainer.style.display=(videoContainer.style.display==='none')?'block':'none';
});

// Initialize
window.onload=()=>{
  positionCalibrationPoints();
  calibrationClickFlow();
  startWebGazer();
  const startStudyBtn=document.querySelector('.helpBtn');
  if(startStudyBtn) startStudyBtn.addEventListener('click',startStudy);
};
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
