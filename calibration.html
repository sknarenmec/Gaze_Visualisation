<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GazeStudy Calibration</title>

<!-- Custom CSS -->
<link rel="stylesheet" type="text/css" href="./css/style.css">

<!-- Bootstrap CSS from CDN -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- WebGazer -->
<script src="./webgazer.js"></script>

<!-- html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/0.4.1/html2canvas.min.js"></script>

<!-- XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- Plotly -->
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

<style>
body { position: relative; }
.red-dot {
  position: absolute;
  background: red;
  border-radius: 100%;
  opacity: 0.7;
  width: 15px;
  height: 15px;
}
#calibrationImage { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; }
#subjectInfo {
  color: #FFFFFF; font-size: 1.5em; font-weight: bold;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
  position: absolute; top: 10px; right: 20px; z-index: 10;
}
.navbar { background-color: #2E3B4E; }
.navbar a { color: #FFFFFF; }
#Accuracy { font-size: 1.2em; font-weight: bold; animation: pulse 1.5s infinite; }
@keyframes pulse { 0% { transform: scale(1); color: red; } 50% { transform: scale(1.05); color: orange; } 100% { transform: scale(1); color: green; } }
.calibrationDiv { position: absolute; top:0; left:0; width:100%; height:100%; }
.Calibration { width: 25px; height: 25px; border-radius: 50%; background: blue; position: absolute; }
</style>
</head>
<body>
<canvas id="plotting_canvas" width="500" height="500" style="cursor:crosshair;"></canvas>
<div id="subjectInfo"></div>

<nav class="navbar navbar-expand-lg navbar-dark fixed-top">
<div class="container-fluid">
  <div class="collapse navbar-collapse" id="myNavbar">
    <ul class="navbar-nav me-auto">
      <li id="Accuracy" class="nav-item"><a class="nav-link">Not yet Calibrated</a></li>
      <li class="nav-item"><a onclick="Restart()" href="#" class="nav-link">Recalibrate</a></li>
    </ul>
    <ul class="navbar-nav ms-auto">
      <li class="nav-item"><a class="helpBtn nav-link" onclick="startStudy()" href="#">Start Study</a></li>
      <li class="nav-item"><a class="nav-link" id="toggleCamBtn" href="#">Show/Hide Camera</a></li>
    </ul>
  </div>
</div>
</nav>

<div class="calibrationDiv">
  <input type="button" class="Calibration" id="Pt1">
  <input type="button" class="Calibration" id="Pt2">
  <input type="button" class="Calibration" id="Pt3">
  <input type="button" class="Calibration" id="Pt4">
  <input type="button" class="Calibration" id="Pt5">
  <input type="button" class="Calibration" id="Pt6">
  <input type="button" class="Calibration" id="Pt7">
  <input type="button" class="Calibration" id="Pt8">
  <input type="button" class="Calibration" id="Pt9">
  <input type="button" class="Calibration" id="Pt10">
  <input type="button" class="Calibration" id="Pt11">
  <input type="button" class="Calibration" id="Pt12">
  <input type="button" class="Calibration" id="Pt13">
  <input type="button" class="Calibration" id="Pt14">
  <input type="button" class="Calibration" id="Pt15">
  <input type="button" class="Calibration" id="Pt16">
  <input type="button" class="Calibration" id="Pt17">
</div>

<div id="helpModal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body">
        <img src="calibration.jpg" width="100%" height="100%">
        <p><b>User should sit closer to the webcamera to attain maximum accuracy</b></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="Restart()">Calibrate</button>
      </div>
    </div>
  </div>
</div>

<img id="calibrationImage" src="demo.jpeg" width="500" height="500">

<!-- Local JS -->
<script src="./js/main.js"></script>
<script src="./js/calibration.js"></script>
<script src="./js/precision_calculation.js"></script>
<script src="./js/precision_store_points.js"></script>
<script src="./js/resize_canvas.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
let gazeData = [];
let isTracking = false;
let startTime;

function startWebGazer() {
  isTracking = true;
  startTime = Date.now();
  webgazer.params.applyKalmanFilter = true;

  // Force video container visible
  setTimeout(() => {
    const videoContainer = document.getElementById('webgazerVideoContainer');
    if (videoContainer) {
      videoContainer.style.display = 'block';
      videoContainer.style.position = 'fixed';
      videoContainer.style.top = '10px';
      videoContainer.style.left = '10px';
      videoContainer.style.width = '320px';
      videoContainer.style.height = '240px';
      videoContainer.style.zIndex = 9999;
    }
  }, 100);

  webgazer.setGazeListener((data) => {
    if (data && isTracking) {
      createRedDot(data.x, data.y);
      gazeData.push({ x: data.x, y: data.y, time: Date.now() - startTime });
    }
  }).begin();
}

function createRedDot(x, y) {
  const dot = document.createElement('div');
  dot.classList.add('red-dot');
  dot.style.left = x + 'px';
  dot.style.top = y + 'px';
  document.body.appendChild(dot);
  setTimeout(() => dot.remove(), 1500);
}

function startStudy() {
  Swal.fire({
    title: 'Start the Study Now?',
    icon: 'info',
    showCancelButton: true,
    confirmButtonText: 'OK'
  }).then((result) => {
    if (result.isConfirmed) window.location.href = 'study.html';
  });
}

// Toggle camera
document.getElementById('toggleCamBtn').addEventListener('click', () => {
  const videoContainer = document.getElementById('webgazerVideoContainer');
  if (videoContainer) videoContainer.style.display = (videoContainer.style.display === 'none') ? 'block' : 'none';
});

// Attach startStudy
const startStudyBtn = document.querySelector('.helpBtn');
if (startStudyBtn) startStudyBtn.addEventListener('click', startStudy);

// Start WebGazer automatically
window.onload = () => startWebGazer();
</script>
</body>
</html>
